<!-- START SIGMA IMPORTS -->
{% extends "basic.html" %}

{% block head %}

{{ super() }}

<script src="{{url_for('static', filename='js/src/sigma.core.js')}}"></script>
<script src="{{url_for('static', filename='js/src/conrad.js')}}"></script>
<script src="{{url_for('static', filename='js/src/utils/sigma.utils.js')}}"></script>
<script src="{{url_for('static', filename='js/src/utils/sigma.polyfills.js')}}"></script>
<script src="{{url_for('static', filename='js/src/sigma.settings.js')}}"></script>
<script src="{{url_for('static', filename='js/src/classes/sigma.classes.dispatcher.js')}}"></script>
<script src="{{url_for('static', filename='js/src/classes/sigma.classes.configurable.js')}}"></script>
<script src="{{url_for('static', filename='js/src/classes/sigma.classes.graph.js')}}"></script>
<script src="{{url_for('static', filename='js/src/classes/sigma.classes.camera.js')}}"></script>
<script src="{{url_for('static', filename='js/src/classes/sigma.classes.quad.js')}}"></script>
<script src="{{url_for('static', filename='js/src/captors/sigma.captors.mouse.js')}}"></script>
<script src="{{url_for('static', filename='js/src/captors/sigma.captors.touch.js')}}"></script>
<script src="{{url_for('static', filename='js/src/renderers/sigma.renderers.canvas.js')}}"></script>
<script src="{{url_for('static', filename='js/src/renderers/sigma.renderers.webgl.js')}}"></script>
<script src="{{url_for('static', filename='js/src/renderers/sigma.renderers.svg.js')}}"></script>
<script src="{{url_for('static', filename='js/src/renderers/sigma.renderers.def.js')}}"></script>
<script src="{{url_for('static', filename='js/src/renderers/webgl/sigma.webgl.nodes.def.js')}}"></script>
<script src="{{url_for('static', filename='js/src/renderers/webgl/sigma.webgl.nodes.fast.js')}}"></script>
<script src="{{url_for('static', filename='js/src/renderers/webgl/sigma.webgl.edges.def.js')}}"></script>
<script src="{{url_for('static', filename='js/src/renderers/webgl/sigma.webgl.edges.fast.js')}}"></script>
<script src="{{url_for('static', filename='js/src/renderers/webgl/sigma.webgl.edges.arrow.js')}}"></script>
<script src="{{url_for('static', filename='js/src/renderers/canvas/sigma.canvas.labels.def.js')}}"></script>
<script src="{{url_for('static', filename='js/src/renderers/canvas/sigma.canvas.hovers.def.js')}}"></script>
<script src="{{url_for('static', filename='js/src/renderers/canvas/sigma.canvas.nodes.def.js')}}"></script>
<script src="{{url_for('static', filename='js/src/renderers/canvas/sigma.canvas.edges.def.js')}}"></script>
<script src="{{url_for('static', filename='js/src/renderers/canvas/sigma.canvas.edges.curve.js')}}"></script>
<script src="{{url_for('static', filename='js/src/renderers/canvas/sigma.canvas.edges.arrow.js')}}"></script>
<script src="{{url_for('static', filename='js/src/renderers/canvas/sigma.canvas.edges.curvedArrow.js')}}"></script>
<script src="{{url_for('static', filename='js/src/renderers/canvas/sigma.canvas.edgehovers.def.js')}}"></script>
<script src="{{url_for('static', filename='js/src/renderers/canvas/sigma.canvas.edgehovers.curve.js')}}"></script>
<script src="{{url_for('static', filename='js/src/renderers/canvas/sigma.canvas.edgehovers.arrow.js')}}"></script>
<script src="{{url_for('static', filename='js/src/renderers/canvas/sigma.canvas.edgehovers.curvedArrow.js')}}"></script>
<script src="{{url_for('static', filename='js/src/renderers/canvas/sigma.canvas.extremities.def.js')}}"></script>
<script src="{{url_for('static', filename='js/src/renderers/svg/sigma.svg.utils.js')}}"></script>
<script src="{{url_for('static', filename='js/src/renderers/svg/sigma.svg.nodes.def.js')}}"></script>
<script src="{{url_for('static', filename='js/src/renderers/svg/sigma.svg.edges.def.js')}}"></script>
<script src="{{url_for('static', filename='js/src/renderers/svg/sigma.svg.edges.curve.js')}}"></script>
<script src="{{url_for('static', filename='js/src/renderers/svg/sigma.svg.edges.curvedArrow.js')}}"></script>
<script src="{{url_for('static', filename='js/src/renderers/svg/sigma.svg.labels.def.js')}}"></script>
<script src="{{url_for('static', filename='js/src/renderers/svg/sigma.svg.hovers.def.js')}}"></script>
<script src="{{url_for('static', filename='js/src/middlewares/sigma.middlewares.rescale.js')}}"></script>
<script src="{{url_for('static', filename='js/src/middlewares/sigma.middlewares.copy.js')}}"></script>
<script src="{{url_for('static', filename='js/src/misc/sigma.misc.animation.js')}}"></script>
<script src="{{url_for('static', filename='js/src/misc/sigma.misc.bindEvents.js')}}"></script>
<script src="{{url_for('static', filename='js/src/misc/sigma.misc.bindDOMEvents.js')}}"></script>
<script src="{{url_for('static', filename='js/src/misc/sigma.misc.drawHovers.js')}}"></script>
<!-- END SIGMA IMPORTS -->
<script src="{{url_for('static', filename='js/plugins/sigma.parsers.json/sigma.parsers.json.js')}}"></script>
<script src="{{url_for('static', filename='js/plugins/sigma.parsers.cypher/sigma.parsers.cypher.js')}}"></script>
<script src="{{url_for('static', filename='js/plugins/sigma.plugins.activeState/sigma.plugins.activeState.js')}}"></script>
<script src="{{url_for('static', filename='js/plugins/sigma.plugins.dragNodes/sigma.plugins.dragNodes.js')}}"></script>
<script src="{{url_for('static', filename='js/plugins/sigma.plugins.animate/sigma.plugins.animate.js')}}"></script>
<script src="{{url_for('static', filename='js/src/misc/sigma.misc.animation.js')}}"></script>
<script src="{{url_for('static', filename='js/src/classes/sigma.classes.dispatcher.js')}}"></script>
<script src="{{url_for('static', filename='js/src/classes/sigma.classes.configurable.js')}}"></script>
<script src="{{url_for('static', filename='js/src/classes/sigma.classes.graph.js')}}"></script>
<script src="{{url_for('static', filename='js/src/classes/sigma.classes.camera.js')}}"></script>
<script src="{{url_for('static', filename='js/src/classes/sigma.classes.quad.js')}}"></script>
<script src="{{url_for('static', filename='js/plugins/sigma.plugins.select/sigma.plugins.select.js')}}"></script>
<script src="{{url_for('static', filename='js/plugins/sigma.plugins.keyboard/sigma.plugins.keyboard.js')}}"></script>
<script src="{{url_for('static', filename='js/plugins/sigma.plugins.activeState/sigma.plugins.activeState.js')}}"></script>
<script src="{{url_for('static', filename='js/src/renderers/svg/sigma.svg.utils.js')}}"></script>
<script src="{{url_for('static', filename='js/src/renderers/svg/sigma.svg.nodes.def.js')}}"></script>
<script src="{{url_for('static', filename='js/src/renderers/svg/sigma.svg.edges.def.js')}}"></script>
<script src="{{url_for('static', filename='js/src/renderers/svg/sigma.svg.edges.curve.js')}}"></script>
<script src="{{url_for('static', filename='js/src/renderers/svg/sigma.svg.labels.def.js')}}"></script>
<script src="{{url_for('static', filename='js/src/renderers/svg/sigma.svg.hovers.def.js')}}"></script>
<script src="{{url_for('static', filename='js/src/middlewares/sigma.middlewares.rescale.js')}}"></script>
<script src="{{url_for('static', filename='js/src/middlewares/sigma.middlewares.copy.js')}}"></script>
<script src="{{url_for('static', filename='js/src/misc/sigma.misc.animation.js')}}"></script>
<script src="{{url_for('static', filename='js/src/misc/sigma.misc.bindEvents.js')}}"></script>
<script src="{{url_for('static', filename='js/src/misc/sigma.misc.bindDOMEvents.js')}}"></script>
<script src="{{url_for('static', filename='js/src/misc/sigma.misc.drawHovers.js')}}"></script>
<script src="{{url_for('static', filename='js/plugins/sigma.renderers.edgeLabels/settings.js')}}"></script>
<script src="{{url_for('static', filename='js/plugins/sigma.renderers.edgeLabels/sigma.canvas.edges.labels.def.js')}}"></script>
<script src="{{url_for('static', filename='js/plugins/sigma.renderers.edgeLabels/sigma.canvas.edges.labels.curve.js')}}"></script>
<script src="{{url_for('static', filename='js/plugins/sigma.renderers.edgeLabels/sigma.canvas.edges.labels.curvedArrow.js')}}"></script>
<script src="{{url_for('static', filename='js/plugins/sigma.exporters.svg/sigma.exporters.svg.js')}}"></script>


<script src="{{url_for('static', filename='js/plugins/sigma.layouts.forceAtlas2/worker.js')}}"></script>
<script src="{{url_for('static', filename='js/plugins/sigma.layouts.forceAtlas2/supervisor.js')}}"></script>
<script src="{{url_for('static', filename='js/plugins/sigma.layouts.forceLink/supervisor.js')}}"></script>
<script src="{{url_for('static', filename='js/plugins/sigma.layouts.forceLink/worker.js')}}"></script>
<script src="{{url_for('static', filename='js/plugins/sigma.plugins.animate/sigma.plugins.animate.js')}}"></script>
<script src="{{url_for('static', filename='js/plugins/sigma.plugins.filter/sigma.plugins.filter.js')}}"></script>
<script src="{{url_for('static', filename='js/plugins/sigma.plugins.tooltips/sigma.plugins.tooltips.js')}}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mustache.js/0.8.1/mustache.min.js"></script>
<style>
      #graph-container {
            top: 80px;
            bottom: 0;
            left: 0;
            right: 0;
            position: absolute;
        }
      #container {
           height: 600px;
           border: 10px;
           position: relative;    
           overflow: hidden;
       }
     .sigma-tooltip {
       max-width: 300px;
       max-height: 400px;
       background-color: #F0F0F0;
       box-shadow: 0 2px 6px rgba(0,0,0,0.3);
       border-radius: 6px;
    }
    .sigma-tooltip-header {
       font-variant: small-caps;
       font-size: 130%;
       font-weight: bold;
       color: #003366;
       background-color: #D8D8D8; 
       border-bottom: 1px solid #181818;
       padding: 10px;
    }
    .sigma-tooltip-body {
       padding: 10px;
    }
    .sigma-tooltip-body th {
      color: #303030;
      text-align: left;
    }
    .sigma-tooltip-footer {
      padding: 10px;
      border-top: 1px solid #181818;
    }
    .sigma-tooltip > .arrow {
      border-width: 10px;
      position: absolute;
      display: block;
      width: 0;
      height: 0;
      border-color: transparent;
      border-style: solid;
    }
    .sigma-tooltip.top {
       margin-top: -12px;
       color: #585858;  
    }
    .sigma-tooltip.top > .arrow {
       left: 50%;
       bottom: -10px;
       margin-left: -10px;
       border-top-color: rgb(249, 247, 237);
       border-bottom-width: 0;
    }
    .sigma-tooltip.bottom {
       margin-top: 12px;
    }
    .sigma-tooltip.bottom > .arrow {
       left: 50%;
       top: -10px;
       margin-left: -10px;
       border-bottom-color: rgb(249, 247, 237);
       border-top-width: 0;
    }
    .sigma-tooltip.left {
       margin-left: -12px;
    }
    .sigma-tooltip.left > .arrow {
       top: 50%;
       right: -10px;
       margin-top: -10px;
       border-left-color: rgb(249, 247, 237);
       border-right-width: 0;
    }
    .sigma-tooltip.right {
       margin-left: 12px;
    }
    .sigma-tooltip.right > .arrow {
       top: 50%;
       left: -10px;
       margin-top: -10px;
       border-right-color: rgb(249, 247, 237);
       border-left-width: 0;
    }
    #control-pane {
       top: 10px;
       right: 10px;
       position: absolute;
       width: 230px;
       background-color: #F0F0F0;
       box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    #control-pane > div {
             margin: 10px;
       overflow-x: auto;
    }
    .line {
       clear: both;
       display: block;
       width: 100%;
       margin: 0;
       padding: 12px 0 0 0;
       border-bottom: 1px solid #000000;
       background: transparent;
    }
    h2, h3, h4 {
       padding: 0;
       font-variant: small-caps;
    }
    .green {
       color: #437356;
    }
    h2.underline {
       color: #003366;
       background: #D8D8D8;
       margin: 0;
       border-radius: 2px;
       padding: 8px 12px;
       font-weight: 700;
       border-bottom: 1px solid #181818;    
    }
    .hidden {
       display: none;
       visibility: hidden;
    }
    input[type=range] {
       width: 160px;
    }

</style>
{% endblock %} <!--head-->

{% block container %}

{{super()}}

<div class="container" id="textarea-container">
    <p>Enter cypher query below (Read queries only)</p>
    <form role="form" action="{{url_for('guest.viz')}}" method="POST">
        <div class="form-group">
            <textarea class="form-control" rows="1" name="query" id="comment" value="{{name}}"></textarea>
        </div>
        <input type="submit" class="btn btn-default" value="Go!">

    </form>
</div>

<div id="container">
    <div id="graph-container"></div>
</div>



<script type="application/javascript">
    var cyphertext='{{temptext|safe}}'
    var initSigma = new sigma ({renderer: {
        container: document.getElementById('graph-container'),
        type: 'canvas'
    },
    settings: {
        labelThreshold: 20,
        defaultLabelSize: 13,
        labelSize: 'fixed',  
        drawEdgeLabels: true,
        minNodeSize: 1.0,
        maxNodeSize: 25.0,
        maxEdgeSize: 2.1,   
        labelAlignment: 'center',
        dragNodeStickiness: 0.01,
        minArrowSize: 15,
        drawEdges: true,
        enableHovering: true,
        sideMargin: 2,
        scalingMode: 'outside',
        animationsTime: 1000,
        enableHovering: true, 
        defaultEdgeLabelSize: 12,
        edgeLabelSize: 'fixed',
        edgeLabelThreshold: 2.0,
    }});

    var label_colors = {
        'Person': 'rgb(218, 37, 104)',
        'Organization': 'rgb(188,218,37)'
    };

    function getLabelClass(label){
        //assuming mutually exlusive class
        var mapping = {
            'Person': ['politician', 'businessperson',
                        'ias'],
            'Organization': ['company', 'party',
                        'constituency']
        };
        if (mapping['Person'].indexOf(label) != -1)
            return 'Person';
        else return 'Organization';
    }

    function customiseGraph(s) {            
        s.graph.nodes().forEach(function(n) {       
            var node_class = getLabelClass(n.neo4j_labels[0]);
            n.color = label_colors[node_class]; 
            
            n.data = {'name':n.neo4j_data['name']
                        , 'uuid':n.neo4j_data['uuid']};

            console.log('Node color' + n.color);

            n.type = n.neo4j_labels[0];
            console.log("type=" + n.type)
            n.size = 16.0;
            n.fixed = false;         
    });

    s.graph.edges().forEach(function(n) {
        n.color = '#989898';        
        n.size = 2.1;
    });

    {% raw %}
    var config = {
      node: {
        show: 'hovers',
        hide: 'hovers',
        cssClass: 'sigma-tooltip',
        position: 'top',
        template:
        '<div class="arrow"></div>' +
        ' <div class="sigma-tooltip-header">{{type}}</div>' +
        '  <div class="sigma-tooltip-body">' +
        '    <table>' +
        '      <tr><th>uuid</th> <td>{{data.uuid}}</td></tr> ' +
        '      <tr><th>name</th> <td>{{data.name}}</td></tr> ' +
        '    </table>' +
        '  </div>' +
        '  <div class="sigma-tooltip-footer">Connections: {{degree}}</div>',
        renderer: function(node, template) {
          node.degree = this.degree(node.id);
          return Mustache.render(template, node);
        }
      }
    };
    {% endraw %}

    var tooltips = sigma.plugins.tooltips(initSigma, initSigma.renderers[0], config);
        var fa = sigma.layouts.configForceLink(initSigma, {
         linLogMode: false, 
         adjustSizes: true,
         worker: true,
         autoStop: true,
         background: true,
         scaleRatio: 3,
         gravity: 2,
         easing: 'cubicInOut',
         nodeSiblingsScale: 5,
         barnesHutOptimize: true,
        });

    sigma.layouts.startForceLink();
    var cam = initSigma.camera;
    sigma.misc.animation.camera(cam, { 
        ratio: 1.9
        });
    initSigma.refresh();
    }
    
    console.log('cypher query-' + cyphertext);
    sigma.neo4j.cypher(
            { url: 'http://{{CORE_GRAPH_HOST}}:{{CORE_GRAPH_PORT}}', user: '{{CORE_GRAPH_USER}}', password: '{{CORE_GRAPH_PASSWORD}}' },
            cyphertext,
            initSigma,
            customiseGraph,
            function(s) {
                console.log('Number of nodes :'+ initSigma.graph.nodes().length);
                console.log('Number of edges :'+ initSigma.graph.edges().length);
            }
    );

    var activeState = sigma.plugins.activeState(initSigma);
    var dragListener = sigma.plugins.dragNodes(initSigma, initSigma.renderers[0], activeState);
    var select = sigma.plugins.select(initSigma, activeState);
    var keyboard = sigma.plugins.keyboard(initSigma, initSigma.renderers[0]);
    select.bindKeyboard(keyboard);
</script>


{% endblock %}
